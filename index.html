<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NPM Dependency Graph Visualizer</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load D3.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
        /* Define the font and base styles */
        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f8fafc;
            overflow: hidden; /* Prevent scroll on full screen */
        }
        
        /* Visualization Container */
        #visualization {
            width: 100%;
            height: 100%;
            cursor: grab;
            outline: none;
        }
        #visualization:active {
            cursor: grabbing;
        }

        /* Glassmorphism Utilities */
        .glass {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        /* Custom Scrollbar for lists if needed */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        /* Transitions */
        .transition-all-300 {
            transition: all 0.3s ease;
        }

        /* Tooltip */
        .graph-tooltip {
            position: absolute;
            pointer-events: none;
            z-index: 50;
            transform: translate(-50%, -100%);
            margin-top: -12px;
            opacity: 0;
            transition: opacity 0.2s;
        }
    </style>
</head>
<body class="h-screen flex flex-col text-slate-800">

    <!-- Header -->
    <header id="app-header" class="bg-white border-b border-slate-200 px-6 py-3 flex justify-between items-center z-20 relative transition-all duration-300">
        <div class="flex items-center gap-3">
            <div class="bg-indigo-600 text-white p-1.5 rounded-lg shadow-sm">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
                </svg>
            </div>
            <h1 class="text-lg font-bold tracking-tight text-slate-800">NPM Visualizer</h1>
        </div>
        <div id="header-controls" class="hidden flex items-center gap-4 text-sm">
            <div class="flex items-center gap-2 text-slate-500 bg-slate-100 px-3 py-1 rounded-full">
                <span class="w-2 h-2 rounded-full bg-rose-500"></span> Root
                <span class="w-2 h-2 rounded-full bg-indigo-500 ml-2"></span> Direct
                <span class="w-2 h-2 rounded-full bg-slate-400 ml-2"></span> Transitive
            </div>
            <button onclick="resetApp()" class="text-slate-500 hover:text-rose-600 font-medium transition-colors">
                Upload New File
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main id="main-content" class="flex-grow relative overflow-hidden bg-slate-50">
        
        <!-- File Drop Zone (Initial State) -->
        <div id="drop-zone-container" class="absolute inset-0 flex flex-col items-center justify-center p-6 transition-all duration-500 z-10">
            <div id="file-drop-area" class="bg-white border-2 border-dashed border-slate-300 rounded-2xl p-12 text-center cursor-pointer transition-all duration-300 hover:border-indigo-500 hover:shadow-xl hover:-translate-y-1 max-w-xl w-full group">
                <input type="file" id="json-file-input" accept=".json" class="hidden">
                
                <div class="w-16 h-16 bg-indigo-50 text-indigo-600 rounded-full flex items-center justify-center mx-auto mb-4 group-hover:scale-110 transition-transform duration-300">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 014 4v2m-5 4H9m1-4l-4 4-4-4m-4 4l4-4 4 4" />
                    </svg>
                </div>
                
                <h2 class="text-2xl font-bold text-slate-800 mb-2">Drop `npm ls --json` here</h2>
                <p class="text-slate-500 mb-6">or click to browse your file system</p>
                
                <div class="flex justify-center gap-8 text-xs text-slate-400 font-medium uppercase tracking-wider">
                    <div class="flex flex-col items-center gap-1">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Secure
                    </div>
                    <div class="flex flex-col items-center gap-1">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                        Fast
                    </div>
                    <div class="flex flex-col items-center gap-1">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 4l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path></svg>
                        Interactive
                    </div>
                </div>
            </div>
            <p id="status-message" class="mt-6 text-slate-500 font-medium animate-pulse hidden">Processing dependency tree...</p>
            <div id="error-message" class="mt-4 bg-red-50 text-red-600 px-4 py-2 rounded-lg border border-red-200 hidden flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <span id="error-text"></span>
            </div>
        </div>

        <!-- Visualization Layer -->
        <div id="visualization-wrapper" class="absolute inset-0 opacity-0 pointer-events-none transition-opacity duration-500 bg-slate-50">
            <svg id="visualization" class="w-full h-full"></svg>
            
            <!-- Floating Toolbar -->
            <div class="absolute top-4 left-4 glass rounded-xl p-2 flex flex-col gap-2 shadow-lg transform transition-transform duration-300 w-56" id="floating-toolbar">
                <!-- Search -->
                <div class="relative group w-full">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400">
                        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    </div>
                    <input type="text" id="search-input" placeholder="Find package..." 
                        class="pl-9 pr-3 py-2 w-full bg-transparent border border-slate-200 rounded-lg text-sm focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition-all placeholder-slate-400 text-slate-700">
                </div>

                <div class="h-px bg-slate-200 my-1"></div>

                <!-- Hover Toggle -->
                <div class="flex items-center justify-between px-2 py-1 cursor-pointer select-none" id="btn-toggle-mode">
                    <span class="text-xs font-medium text-slate-600">Hover Highlight</span>
                    <div class="relative">
                        <div class="w-9 h-5 bg-indigo-500 rounded-full transition-colors duration-200" id="toggle-track"></div>
                        <div class="absolute top-1 left-1 bg-white w-3 h-3 rounded-full shadow-sm transform transition-transform duration-200 translate-x-4" id="toggle-thumb"></div>
                    </div>
                </div>

                <!-- Tooltip Toggle -->
                <div class="flex items-center justify-between px-2 py-1 cursor-pointer select-none" id="btn-toggle-tooltip">
                    <span class="text-xs font-medium text-slate-600">Show Names</span>
                    <div class="relative">
                        <div class="w-9 h-5 bg-indigo-500 rounded-full transition-colors duration-200" id="toggle-track-tooltip"></div>
                        <div class="absolute top-1 left-1 bg-white w-3 h-3 rounded-full shadow-sm transform transition-transform duration-200 translate-x-4" id="toggle-thumb-tooltip"></div>
                    </div>
                </div>

                <!-- Lock Layout Toggle -->
                <div class="flex items-center justify-between px-2 py-1 cursor-pointer select-none" id="btn-toggle-lock">
                    <span class="text-xs font-medium text-slate-600">Lock Layout</span>
                    <div class="relative">
                        <div class="w-9 h-5 bg-slate-300 rounded-full transition-colors duration-200" id="toggle-track-lock"></div>
                        <div class="absolute top-1 left-1 bg-white w-3 h-3 rounded-full shadow-sm transform transition-transform duration-200 translate-x-0" id="toggle-thumb-lock"></div>
                    </div>
                </div>

                <div class="h-px bg-slate-200 my-1"></div>

                <!-- Zoom Controls -->
                <div class="grid grid-cols-3 gap-1 w-full">
                    <button id="btn-zoom-in" class="flex justify-center items-center p-2 text-slate-600 hover:bg-slate-100 rounded-lg transition-colors" title="Zoom In">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                    </button>
                    <button id="btn-zoom-out" class="flex justify-center items-center p-2 text-slate-600 hover:bg-slate-100 rounded-lg transition-colors" title="Zoom Out">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path></svg>
                    </button>
                    <button id="btn-reset-view" class="flex justify-center items-center p-2 text-slate-600 hover:bg-slate-100 rounded-lg transition-colors" title="Reset View">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 4l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path></svg>
                    </button>
                </div>
            </div>

            <!-- Stats Overlay -->
            <div class="absolute bottom-4 right-4 glass px-4 py-2 rounded-lg text-xs font-medium text-slate-500 shadow-sm pointer-events-none">
                <span id="stat-nodes">0</span> Nodes â€¢ <span id="stat-links">0</span> Dependencies
            </div>

        </div>

        <!-- Custom Tooltip -->
        <div id="tooltip" class="glass px-4 py-3 rounded-xl shadow-xl border border-white/50 graph-tooltip backdrop-blur-md">
            <div class="font-bold text-slate-800 text-sm" id="tt-name">Package</div>
            <div class="text-xs text-indigo-600 font-mono mt-0.5" id="tt-version">v1.0.0</div>
            <div class="mt-2 flex items-center gap-2 text-xs text-slate-500 border-t border-slate-200 pt-2">
                <span class="flex items-center gap-1"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" /></svg><span id="tt-deps">0</span> Deps</span>
                <span class="w-1 h-1 bg-slate-300 rounded-full"></span>
                <span id="tt-depth">Depth 0</span>
            </div>
        </div>

    </main>

    <script type="module">
        // Global State
        let svg, g, simulation, zoom;
        let rootData;
        let graphData = { nodes: [], links: [] };
        let linkElements, nodeElements;
        let width, height;
        let activeSearch = '';
        let focusNodeId = null;
        
        // Settings
        let hoverEnabled = true;
        let tooltipEnabled = true;
        let layoutLocked = false;

        // DOM Elements
        const dropZoneContainer = document.getElementById('drop-zone-container');
        const visualizationWrapper = document.getElementById('visualization-wrapper');
        const headerControls = document.getElementById('header-controls');
        const statusMessage = document.getElementById('status-message');
        const errorMessage = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        const dropArea = document.getElementById('file-drop-area');
        const fileInput = document.getElementById('json-file-input');
        const searchInput = document.getElementById('search-input');
        
        // Hover Highlight Toggle DOM
        const toggleBtn = document.getElementById('btn-toggle-mode');
        const toggleTrack = document.getElementById('toggle-track');
        const toggleThumb = document.getElementById('toggle-thumb');

        // Tooltip Toggle DOM
        const toggleBtnTooltip = document.getElementById('btn-toggle-tooltip');
        const toggleTrackTooltip = document.getElementById('toggle-track-tooltip');
        const toggleThumbTooltip = document.getElementById('toggle-thumb-tooltip');

        // Lock Toggle DOM
        const toggleBtnLock = document.getElementById('btn-toggle-lock');
        const toggleTrackLock = document.getElementById('toggle-track-lock');
        const toggleThumbLock = document.getElementById('toggle-thumb-lock');
        
        // --- Initialization & Event Listeners ---

        window.resetApp = function() {
            // Reset View
            dropZoneContainer.classList.remove('pointer-events-none', 'opacity-0');
            visualizationWrapper.classList.add('opacity-0', 'pointer-events-none');
            headerControls.classList.add('hidden');
            statusMessage.classList.add('hidden');
            errorMessage.classList.add('hidden');
            
            // Reset Data
            graphData = { nodes: [], links: [] };
            focusNodeId = null;
            searchInput.value = '';
            if(simulation) simulation.stop();
            d3.select("#visualization").selectAll("*").remove();
        };

        // File handling
        dropArea.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => handleFile(e.target.files[0]));

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, (e) => { e.preventDefault(); e.stopPropagation(); }, false);
            document.body.addEventListener(eventName, (e) => { e.preventDefault(); e.stopPropagation(); }, false);
        });

        ['dragenter', 'dragover'].forEach(evt => dropArea.addEventListener(evt, () => dropArea.classList.add('border-indigo-500', 'bg-indigo-50'), false));
        ['dragleave', 'drop'].forEach(evt => dropArea.addEventListener(evt, () => dropArea.classList.remove('border-indigo-500', 'bg-indigo-50'), false));
        dropArea.addEventListener('drop', (e) => handleFile(e.dataTransfer.files[0]), false);

        // Control Listeners
        document.getElementById('btn-zoom-in').addEventListener('click', () => svg.transition().duration(300).call(zoom.scaleBy, 1.3));
        document.getElementById('btn-zoom-out').addEventListener('click', () => svg.transition().duration(300).call(zoom.scaleBy, 1 / 1.3));
        document.getElementById('btn-reset-view').addEventListener('click', resetZoom);
        searchInput.addEventListener('input', (e) => handleSearch(e.target.value));
        
        toggleBtn.addEventListener('click', () => {
            hoverEnabled = !hoverEnabled;
            updateToggleUI();
        });

        toggleBtnTooltip.addEventListener('click', () => {
            tooltipEnabled = !tooltipEnabled;
            updateTooltipToggleUI();
        });

        toggleBtnLock.addEventListener('click', () => {
            layoutLocked = !layoutLocked;
            updateLockToggleUI();
        });

        function updateToggleUI() {
            if (hoverEnabled) {
                toggleTrack.classList.replace('bg-slate-300', 'bg-indigo-500');
                toggleThumb.classList.replace('translate-x-0', 'translate-x-4');
            } else {
                toggleTrack.classList.replace('bg-indigo-500', 'bg-slate-300');
                toggleThumb.classList.replace('translate-x-4', 'translate-x-0');
                // If we turn off hover while nothing is focused, clear any lingering highlights
                if (!focusNodeId) resetHighlight();
            }
        }

        function updateTooltipToggleUI() {
            if (tooltipEnabled) {
                toggleTrackTooltip.classList.replace('bg-slate-300', 'bg-indigo-500');
                toggleThumbTooltip.classList.replace('translate-x-0', 'translate-x-4');
            } else {
                toggleTrackTooltip.classList.replace('bg-indigo-500', 'bg-slate-300');
                toggleThumbTooltip.classList.replace('translate-x-4', 'translate-x-0');
                if (!focusNodeId) hideTooltip();
            }
        }

        function updateLockToggleUI() {
            if (layoutLocked) {
                toggleTrackLock.classList.replace('bg-slate-300', 'bg-indigo-500');
                toggleThumbLock.classList.replace('translate-x-0', 'translate-x-4');
            } else {
                toggleTrackLock.classList.replace('bg-indigo-500', 'bg-slate-300');
                toggleThumbLock.classList.replace('translate-x-4', 'translate-x-0');
            }
        }

        // --- Logic ---

        function handleFile(file) {
            if (!file || file.type !== 'application/json') {
                showError('Please upload a valid JSON file.');
                return;
            }

            statusMessage.classList.remove('hidden');
            errorMessage.classList.add('hidden');

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const json = JSON.parse(e.target.result);
                    processData(json);
                } catch (err) {
                    showError('Error parsing JSON. Is it a valid npm ls output?');
                }
            };
            reader.readAsText(file);
        }

        function showError(msg) {
            statusMessage.classList.add('hidden');
            errorMessage.classList.remove('hidden');
            errorText.textContent = msg;
        }

        function processData(data) {
            // Transform Data
            const nodes = [];
            const links = [];
            const nodeMap = new Map();
            const linkSet = new Set();

            if (!data.name) data.name = 'root';
            if (!data.version) data.version = '0.0.0';

            function traverse(pkg, parentId = null, depth = 0) {
                if (!pkg) return;
                
                const name = pkg.name || 'unknown';
                const version = pkg.version || '0.0.0';
                const id = `${name}@${version}`;
                
                if (!nodeMap.has(id)) {
                    const node = { 
                        id, 
                        name, 
                        version, 
                        depth, 
                        degree: 0, // Total connections
                        inDegree: 0 // incoming connections
                    };
                    nodes.push(node);
                    nodeMap.set(id, node);
                } else {
                    // Keep the shallowest depth encountered
                    const node = nodeMap.get(id);
                    if (depth < node.depth) node.depth = depth;
                }

                if (parentId && parentId !== id) {
                    const linkId = `${parentId}->${id}`;
                    if (!linkSet.has(linkId)) {
                        links.push({ source: parentId, target: id });
                        linkSet.add(linkId);
                        nodeMap.get(parentId).degree++;
                        nodeMap.get(id).inDegree++;
                        nodeMap.get(id).degree++;
                    }
                }

                if (pkg.dependencies) {
                    Object.entries(pkg.dependencies).forEach(([depName, depData]) => {
                        depData.name = depName; // Ensure name is attached
                        traverse(depData, id, depth + 1);
                    });
                }
            }

            traverse(data);

            if (nodes.length === 0) {
                showError('No dependencies found in file.');
                return;
            }

            graphData = { nodes, links };
            
            // Update UI Stats
            document.getElementById('stat-nodes').textContent = nodes.length;
            document.getElementById('stat-links').textContent = links.length;

            // Switch View
            dropZoneContainer.classList.add('pointer-events-none', 'opacity-0');
            visualizationWrapper.classList.remove('opacity-0', 'pointer-events-none');
            headerControls.classList.remove('hidden');
            statusMessage.classList.add('hidden');

            // Render
            setTimeout(() => initGraph(), 100); // Small delay for DOM transition
        }

        function initGraph() {
            const container = document.getElementById('visualization-wrapper');
            width = container.clientWidth;
            height = container.clientHeight;

            svg = d3.select("#visualization")
                .attr("viewBox", [0, 0, width, height]);
            
            // Define Arrow Marker
            svg.append("defs").selectAll("marker")
                .data(["end"])
                .enter().append("marker")
                .attr("id", "arrow")
                .attr("viewBox", "0 -5 10 10")
                .attr("refX", 20) // Offset from node center (adjusted for node radius)
                .attr("refY", 0)
                .attr("markerWidth", 6)
                .attr("markerHeight", 6)
                .attr("orient", "auto")
                .append("path")
                .attr("d", "M0,-5L10,0L0,5")
                .attr("fill", "#94a3b8"); // Slate-400

            g = svg.append("g");

            zoom = d3.zoom()
                .scaleExtent([0.1, 4])
                .on("zoom", (e) => g.attr("transform", e.transform));

            svg.call(zoom)
               .on("dblclick.zoom", null); // Disable dblclick zoom

            // Simulation setup
            simulation = d3.forceSimulation(graphData.nodes)
                .force("link", d3.forceLink(graphData.links).id(d => d.id).distance(80))
                .force("charge", d3.forceManyBody().strength(-200).distanceMax(400))
                .force("center", d3.forceCenter(width / 2, height / 2))
                .force("collide", d3.forceCollide().radius(d => 5 + Math.sqrt(d.degree) * 3).iterations(2));

            // --- Links ---
            linkElements = g.append("g")
                .attr("stroke", "#cbd5e1") // Slate-300
                .attr("stroke-opacity", 0.6)
                .selectAll("line")
                .data(graphData.links)
                .join("line")
                .attr("stroke-width", 1)
                .attr("marker-end", "url(#arrow)");

            // --- Nodes ---
            // Define drag behavior with filter
            const drag = d3.drag()
                .filter(event => !layoutLocked) // Allow drag only if layoutLocked is false
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended);

            nodeElements = g.append("g")
                .attr("stroke", "#fff")
                .attr("stroke-width", 1.5)
                .selectAll("circle")
                .data(graphData.nodes)
                .join("circle")
                .attr("r", d => 5 + Math.sqrt(d.degree) * 2) // Dynamic Size
                .attr("fill", getNodeColor)
                .attr("class", "cursor-pointer transition-opacity duration-200")
                .call(drag);

            // Events
            nodeElements
                .on("mouseover", (event, d) => {
                    // Check tooltip toggle
                    if (tooltipEnabled) {
                        showTooltip(event, d);
                    }
                    
                    // Only highlight if hover is enabled AND we aren't currently focused on a specific node
                    if (hoverEnabled && !focusNodeId) {
                        highlightNode(d);
                    }
                })
                .on("mouseout", () => {
                    hideTooltip();
                    // Only clear highlight if hover is enabled AND we aren't focused on a node
                    if (hoverEnabled && !focusNodeId) {
                        resetHighlight();
                    }
                })
                .on("click", (event, d) => {
                    event.stopPropagation();
                    toggleFocus(d);
                });

            // Click background to reset focus
            svg.on("click", () => {
                focusNodeId = null;
                resetHighlight();
                hideTooltip();
            });

            simulation.on("tick", () => {
                linkElements
                    .attr("x1", d => d.source.x)
                    .attr("y1", d => d.source.y)
                    .attr("x2", d => d.target.x)
                    .attr("y2", d => d.target.y);

                nodeElements
                    .attr("cx", d => d.x)
                    .attr("cy", d => d.y);
            });
        }

        // --- Graph Interaction Logic ---

        function getNodeColor(d) {
            if (d.depth === 0) return "#f43f5e"; // Rose-500 (Root)
            if (d.depth === 1) return "#6366f1"; // Indigo-500 (Direct)
            return "#94a3b8"; // Slate-400 (Transitive)
        }

        function toggleFocus(d) {
            if (focusNodeId === d.id) {
                focusNodeId = null;
                resetHighlight();
            } else {
                focusNodeId = d.id;
                highlightNode(d, true); // Pass true to trace ancestry
                showTooltip(null, d); // Keep tooltip open
                
                // Center view on node
                svg.transition().duration(750).call(
                    zoom.transform,
                    d3.zoomIdentity.translate(width / 2, height / 2).scale(1.5).translate(-d.x, -d.y)
                );
            }
        }

        function highlightNode(d, traceAncestry = false) {
            // Identify connections
            const connectedNodeIds = new Set();
            const connectedLinkIndices = new Set();
            
            // Neighbors
            graphData.links.forEach((l, i) => {
                if (l.source.id === d.id || l.target.id === d.id) {
                    connectedNodeIds.add(l.source.id);
                    connectedNodeIds.add(l.target.id);
                    connectedLinkIndices.add(i);
                }
            });

            // Path to Root (Ancestry) logic
            if (traceAncestry) {
                // Trace backwards up the tree to root
                const queue = [d.id];
                const visited = new Set([d.id]);
                while(queue.length > 0) {
                    const currId = queue.shift();
                    // Find links where target is current (parents)
                    graphData.links.forEach((l, i) => {
                        if (l.target.id === currId) {
                            connectedLinkIndices.add(i);
                            connectedNodeIds.add(l.source.id);
                            if (!visited.has(l.source.id)) {
                                visited.add(l.source.id);
                                queue.push(l.source.id);
                            }
                        }
                    });
                }
            }

            // Apply styles
            nodeElements.attr('opacity', n => (n.id === d.id || connectedNodeIds.has(n.id)) ? 1 : 0.1);
            linkElements.attr('stroke-opacity', (l, i) => connectedLinkIndices.has(i) ? 1 : 0.05);
            linkElements.attr('stroke', (l, i) => connectedLinkIndices.has(i) ? '#6366f1' : '#cbd5e1'); // Highlight color
        }

        function resetHighlight() {
            nodeElements.attr('opacity', 1);
            linkElements.attr('stroke-opacity', 0.6).attr('stroke', '#cbd5e1');
        }

        function handleSearch(query) {
            activeSearch = query.toLowerCase();
            if (!activeSearch) {
                resetHighlight();
                return;
            }

            const match = graphData.nodes.find(n => n.id.toLowerCase().includes(activeSearch));
            if (match) {
                // Highlight matches
                nodeElements.attr('opacity', n => n.id.toLowerCase().includes(activeSearch) ? 1 : 0.1);
                // Zoom to first match
                svg.transition().duration(500).call(
                    zoom.transform,
                    d3.zoomIdentity.translate(width / 2, height / 2).scale(2).translate(-match.x, -match.y)
                );
            }
        }

        function resetZoom() {
            svg.transition().duration(750).call(
                zoom.transform,
                d3.zoomIdentity
            );
            focusNodeId = null;
            resetHighlight();
            hideTooltip();
        }

        // --- Tooltip Logic ---
        const tooltip = document.getElementById('tooltip');
        const ttName = document.getElementById('tt-name');
        const ttVersion = document.getElementById('tt-version');
        const ttDeps = document.getElementById('tt-deps');
        const ttDepth = document.getElementById('tt-depth');

        function showTooltip(event, d) {
            ttName.textContent = d.name;
            ttVersion.textContent = `v${d.version}`;
            ttDeps.textContent = d.degree;
            ttDepth.textContent = d.depth === 0 ? 'Root' : `Depth ${d.depth}`;

            tooltip.style.opacity = 1;
            
            // If triggered by event (hover), follow mouse. If programmatic (click focus), position near node
            if (event) {
                tooltip.style.left = (event.pageX) + 'px';
                tooltip.style.top = (event.pageY - 10) + 'px';
            } else {
                // Use internal zoom transform to project node coordinates to screen
                const transform = d3.zoomTransform(svg.node());
                const screenX = transform.applyX(d.x);
                const screenY = transform.applyY(d.y);
                tooltip.style.left = (screenX + document.getElementById('visualization-wrapper').getBoundingClientRect().left) + 'px';
                tooltip.style.top = (screenY + document.getElementById('visualization-wrapper').getBoundingClientRect().top - 15) + 'px';
            }
        }

        function hideTooltip() {
            tooltip.style.opacity = 0;
        }

        // --- D3 Drag ---
        function dragstarted(event) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            event.subject.fx = event.subject.x;
            event.subject.fy = event.subject.y;
        }

        function dragged(event) {
            event.subject.fx = event.x;
            event.subject.fy = event.y;
        }

        function dragended(event) {
            if (!event.active) simulation.alphaTarget(0);
            event.subject.fx = null;
            event.subject.fy = null;
        }
    </script>
</body>
</html>
